
# 概要

processmonitor - プロセスをバックグラウンドで立ち上げ疑似シェルを提供するシェルスクリプト

# 構成

- 📂project: 模擬的なゲームプログラム
  - 📂excluded: バックアップに含めないディレクトリ
    - 📄cache.txt: バックアップに含めないファイル
  - 📂excluded2: バックアップに含めないディレクトリ
    - 📄debug-log.txt: バックアップに含めないファイル
  - 📂included: バックアップに含めるディレクトリ
    - 📄savedata.txt: バックアップに含めるファイル
  - ⚙game.pl: 模擬ゲームプログラム本体
- 📂processmonitor: プロセスモニタ本体
  - 📝config.sh: 設定記述用ファイル
  - ⚙run.sh: プロセス起動スクリプト
  - ⚙teerun.sh: sendできる状態でrunするスクリプト
  - ⚙init.sh: 周辺ファイルを準備するスクリプト
  - ⚙processtree.sh: 指定したpidの子孫プロセスのpidを取得するスクリプト
  - ⚙send.sh: teerunしたプロセスの標準入力にメッセージを送るスクリプト
  - ⚙monitor.sh: teerunしたプロセスのログ出力を監視し、入力をプロセスに渡すスクリプト
  - ⚙up.sh: 排他制御付きでバックグラウンドで立ち上げるスクリプト
  - ⚙isup.sh: upされているか否かを取得するスクリプト
  - ⚙down.sh: upされたプロセスを終了させるスクリプト
  - ⚙backup.sh: バックアップ作成スクリプト

# 機能

## 全般

📝config.shにはprocessmonitorが取り扱うプロセスの配置情報等を記入できる。

📂processmonitorのうち、
⚙とマークされているものはどのようなカレントディレクトリから呼び出しても自動的にカレントディレクトリを設定し直し、
同一の動きをするようになっている。

## 模擬ゲーム

📂projectは、ゲームサーバーなどのプロセスの代わりとなる模擬的なプログラムが入っている。
📂project内で`perl ⚙game.pl`を起動すると、プロセスが起動する。

プロセスは標準入力をひたすら待ち、受け取った行に記号を付けて表示する。
行を受け取るごとに確率でエラーメッセージを出力する。
`stop`という行を送ると、プロセスは正常終了する。

プロセスに対していくつかのシグナルを送ると、その旨を出力し、終了する。
標準入力が閉じた場合も終了する。

プロセスはlatest.logに対して標準出力とエラー出力の内容をロギングする。
ファイルのローリング等は特にされず、起動ごとにログファイルに上書きしていく。

これはMinecraftのサーバープロセスの挙動を模したものである。

## 起動

$`bash ⚙run.sh`を実行すると対象のプロセスが呼び出される。
動作の設定が📝config.shでできること、
どこから呼び出しても正しく動作することを除いて、
⚙game.plを普通に呼び出すのと変わらない。

## バックドア付き起動

$`bash ⚙teerun.sh`を実行すると内部で⚙run.shを呼び出してプロセスが立ち上がるが、
⚙teerun.shで立ち上げたプロセスの標準入力には$`bash ⚙send.sh 'メッセージ'`を通してメッセージを送ることができる。
$`bash ⚙monitor.sh`をするとシェルが起動し、
プロセスが出力するログファイルの内容が表示される。

⚙monitor.shは、入力された標準入力を⚙teerun.shで起動しているプロセスに渡す動作を持っている。
つまり、⚙monitor.shは疑似的にそのプロセスを立ち上げたシェルを再現する働きがある。
ただし、⚙monitor.shはプロセスの出力を見ているのではなくログファイルを見ているため、
プロセスがロギング機構を持っていることが必要となる。

⚙teerun.shには排他制御がないため、複数のプロセスを同時に走らせることができてしまう。
その状態では、⚙send.shや⚙monitor.shの動作は不安定なものとなる。

⚙send.shや⚙monitor.shは📂processmonitorにアクセスできさえすればどこからでも呼び出せるため、
crontabから自動実行したり、sshの接続時コマンドで呼び出すことができる。

## 排他制御付きバックグラウンド起動

$`bash ⚙up.sh`を実行すると、排他制御付きでバックグラウンドプロセスとして⚙teerun.shを呼び出す。
⚙up.shを実行すると即復帰し、もはや標準入力・標準出力・エラー出力にアクセスすることはできない。
代わりに⚙monitor.shを使ってこれらのストリームに疑似的にアクセスすることができる。
内部で⚙teerun.shを呼び出しているので、バックドア機能も提供する。

⚙up.shには排他制御がついており、同時に複数のプロセスがupされることはない。
既に別のプロセスがupによって走っている状態でupをさらに呼び出すと、
後に呼び出した側がエラーを出して終了する。
排他制御は⚙up.shによって起動されたものだけが行われ、
⚙run.shや⚙teerun.shによって呼び出されたプロセスは排他制御の対象にならない。

$`bash ⚙down.sh`を実行すると、upされているプロセスがある場合に限り、
⚙send.shを介して終了命令を送る。
⚙down.shは対象のプロセスにシグナルを送ることで終了させるのではなく、
飽くまで対象のプロセスが標準入力に与えられた命令を能動的に解釈し、
自身の内部機能によって終了することを促す。
終了命令は📝config.shで指定できる。

$`bash ⚙isup.sh`は、upされている状態ならば終了コード0を返すスクリプトである。
また、標準出力にtrueかfalseを出す。
このスクリプトはシェルスクリプトから呼び出して分岐処理に使うことができるほか、
直接呼び出しても人間が確認できる形で結果を返す。

## バックアップ

`bash ⚙backup.sh`を呼び出すと対象のプロセスが置いてあるディレクトリを丸ごとzip圧縮する。
アーカイブの格納場所等の設定は📝config.shで行う。
アーカイブに含めたくないファイルを指定することもできる。

# インストール

## Linux環境において、設置対象のディレクトリを用意し、カレントディレクトリにする。

設置対象のディレクトリ内には、`processmonitor`ディレクトリや、他のシェルスクリプトがあってはならない。
そうでなければ、既にファイルが存在すディレクトリ上で作業を行ってもよい。
ただし、Windows Subsystem for LinuxによってマウントしたWindows上のフォルダは、パイプなどが設置できないため、コンフィグを設定する必要がある。

## ファイルを配置

- 設置対象のディレクトリ$ `git clone https://github.com/MirrgieRiana/processmonitor.git`
- 設置対象のディレクトリ$ `mv processmonitor/processmonitor/* .`

この時点で、カレントディレクトリ直下に大量のスクリプトファイルが並ぶ。

## 一時ファイルの削除

`processmonitor`ディレクトリは不要であるため、削除してもよい。

- 設置対象のディレクトリ$ `rm -rf processmonitor`

再利用のためにそのまま残しておいてもよい。

## コンフィグの設定

- 設置対象のディレクトリ$ `nano config.sh`

```
project_dir=../project
command="perl game.pl"
log_file="latest.log"
backup_base_name=game
backup_dir=../_backup
backup_exclusions="
  'excluded/*'
  'excluded2/*'
"
stop_operator=stop
pipe1_file=_pipe1
pipe2_file=_pipe2
lock_file=_lock
```

対象のアプリケーションが置かれているパスを`project_dir`に指定する。
相対パスにした場合、スクリプトが置いてある場所からの相対パスになる。
アプリケーションはスクリプトが置いてあるディレクトリ内に設置してもよい。

コマンドを`command`に指定する。
空白を含む値は`"`で囲むこと。
このコマンドは`project_dir`上で実行される。

ログファイルが置かれる場所を`log_file`に指定する。
`project_dir`からの相対パスとして記述する。
例えば、`${project_dir}/logs/log.txt`がログファイルならば、`log_file=logs/log.txt`と書けばよい。

`backup_base_name`・`backup_dir`・`backup_exclusions`はバックアップの動作を設定する項目である。
`backup_base_name`はZIPファイルの名前に使われる。
実際にはこの文字列にタイムスタンプと拡張子がさらに付与されるので、ベースとなる名前だけを記述すればよい。
`backup_dir`は、スクリプトファイルからの相対位置で指定する。
`backup_exclusions`は、バックアップから除外したいパスを、`project_dir`内でのパスとして記述する。
ただし、ディレクトリ名は末尾に`/*`を付け、ファイル名にマッチするようにしなければならない。
更に`'`で囲み、`*`の展開を防止ししなければならない。
空白文字で区切ることで、0個以上の項目を指定することができる。

`stop_operator`は、そのアプリケーションを閉じるために標準入力から与えるコマンドである。
アプリケーションにそのような機能がなければ、停止させることはできない。

`pipe1_file`・`pipe2_file`・`lock_file`は、スクリプトの動作上必要となるファイルを設置する場所を指定する。
これはスクリプトファイルからの相対パスで表される。
`pipe`とあるものはパイプで、`lock`とあるものは通常ファイルである。
パイプを設置できるファイルシステムは限られるため、設置できない環境に置く場合は別所にパイプを置く場所を確保する必要がある。
これらのファイルはスクリプトの動作上、作成されただけで編集されることがないため、再起動で初期化されるディレクトリ上に配置してもよい。
